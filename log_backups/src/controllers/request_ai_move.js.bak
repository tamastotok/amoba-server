const Boards = require('../models/Boards');
const { simpleAIMove } = require('../utils/ai/simple_ai_move');
const { heuristicAIMove } = require('../utils/ai/heuristic_ai_move');
const { geneticAIMove } = require('../utils/ai/genetic_ai_move');
const { loadLatestPopulation } = require('../utils/ai/evolution');
const aiState = require('../utils/ai_state');

module.exports = async function requestAIMove(socket, io, data) {
  try {
    const { roomId, playerMark } = data;
    if (!roomId) {
      console.warn('requestAIMove called without roomId');
      return;
    }

    // Get current game state from database
    const boardDoc = await Boards.findOne({ roomId }).lean();
    if (!boardDoc) {
      console.warn(`No board found for room ${roomId}`);
      return;
    }

    const size = boardDoc.boardSize;
    const board = Array.from({ length: size }, () => Array(size).fill(''));

    // Convert DB positions into a 2D array
    for (const p of boardDoc.positions || []) {
      board[p.row][p.col] = p.value; // 'X' or 'O'
    }

    // Determine player/AI marks
    const humanMark = playerMark;
    const aiMark = humanMark === 'X' ? 'O' : 'X';

    // Get difficulty (from DB or client)
    const difficulty = boardDoc.difficulty;

    let move;

    // ---------------------------
    // Choose AI algorithm
    // ---------------------------
    if (difficulty === 'easy') {
      // Easy: random-based
      move = simpleAIMove(board, size, aiMark, humanMark);
    } else if (difficulty === 'medium') {
      // Medium: heuristic (block + attack patterns)
      move = heuristicAIMove(board, size, aiMark, humanMark);
    } else if (difficulty === 'hard') {
      // Hard: Genetic learning AI

      // Load or initialize population (only once)
      if (!aiState.population.length) {
        const latest = await loadLatestPopulation();
        aiState.population = latest.population;
        aiState.currentGeneration = latest.generation;
      }

      // Pick a random strategy from the current generation
      const strategy =
        aiState.population[
          Math.floor(Math.random() * aiState.population.length)
        ];

      // Execute move using the chosen strategy
      move = geneticAIMove(board, size, aiMark, humanMark, strategy);

      // Store which strategy belongs to this room for learning at game-end
      move.strategyId = strategy.id;

      aiState.strategyPerRoom.set(roomId, move.strategyId);
    }

    // Validate move
    if (!move) {
      console.log(`AI (${aiMark}) could not find a move for room ${roomId}`);
      return;
    }

    move.value = aiMark;

    // Update the game board in MongoDB
    await Boards.updateOne(
      { roomId },
      {
        $push: { positions: { row: move.row, col: move.col, value: aiMark } },
        $set: { nextMark: humanMark },
      }
    );

    // Add a small random delay (looks more human)
    const delay = Math.floor(800 + Math.random() * 500);
    setTimeout(() => {
      io.to(roomId).emit('ai-move', move);
      console.log(
        `[${difficulty}] AI (${aiMark}) moved in room ${roomId}: [${move.row}, ${move.col}]`
      );
    }, delay);
  } catch (err) {
    console.error('AI move error:', err);
  }
};
