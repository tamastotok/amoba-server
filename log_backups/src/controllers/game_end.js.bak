const Boards = require('../models/Boards');
const {
  loadLatestPopulation,
  updateFitness,
  evolvePopulation,
  savePopulationToDB,
} = require('../utils/ai/evolution');
const { endedRooms } = require('../utils/room_state');
const aiState = require('../utils/ai_state');

module.exports = async function gameEnd(socket, io, data) {
  try {
    const { roomId, result } = data; // winner: 'player' | 'ai' | 'draw' (frontend-től)

    if (!roomId) {
      console.warn('No roomId found in gameEnd');
      return;
    }

    // ---------------------------
    // AI learning update (HARD only)
    // ---------------------------
    const strategyId = aiState.strategyPerRoom.get(roomId);

    if (strategyId) {
      // Ensure population is loaded
      if (!aiState.population.length) {
        const latest = await loadLatestPopulation();
        aiState.population.length = 0;
        aiState.population.push(...latest.population);
        aiState.currentGeneration = latest.generation;
      }

      switch (result) {
        case 'player':
          // player won -> AI lost
          updateFitness(aiState.population, 'loss', strategyId);
          break;
        case 'ai':
          // AI won
          updateFitness(aiState.population, 'win', strategyId);
          break;
        default:
          // draw
          updateFitness(aiState.population, 'draw', strategyId);
      }

      aiState.gamesPlayed++;

      if (aiState.gamesPlayed % 20 === 0) {
        aiState.population = evolvePopulation(aiState.population);
        aiState.currentGeneration++;
        await savePopulationToDB(aiState.population, aiState.currentGeneration);

        io.emit('ai-generation-update', {
          generation: aiState.currentGeneration,
          population: aiState.population,
          timestamp: new Date().toISOString(),
        });

        aiState.gamesPlayed = 0;
      }

      // room → strategy mapping delete
      aiState.strategyPerRoom.delete(roomId);
    }

    // ---------------------------
    // Normal game-end logic
    // ---------------------------
    socket.emit('game-ended');

    endedRooms.add(roomId);

    await Boards.deleteOne({ roomId });
    console.log(`Game ended in room ${roomId}, winner: ${result}`);

    socket.leave(roomId);

    setTimeout(() => endedRooms.delete(roomId), 5000);
  } catch (err) {
    console.error('Error in game_end:', err);
  }
};
